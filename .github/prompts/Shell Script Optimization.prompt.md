---
description: '优化现有 Shell 脚本的性能和可靠性'
mode: 'edit'
tools: ['codebase']
---

# Shell 脚本优化

请帮我优化选中的 Shell 脚本，重点关注以下方面：

## 性能优化

### 命令优化
- 使用更高效的命令替代，如用 `ip` 替代 `ifconfig`
- 减少外部命令调用，优先使用 bash 内置功能
- 避免不必要的管道操作和子shell
- 使用数组而不是多次字符串操作

### 网络操作优化
- 批量处理 iptables 规则而不是逐条添加
- 缓存网络接口信息避免重复查询
- 使用 `ip link show` 的高效参数组合

## 可靠性增强

### 错误处理
- 添加完整的错误检查和恢复机制
- 使用 `set -euo pipefail` 增强错误检测
- 为关键操作添加重试机制
- 确保临时文件和资源的正确清理

### 配置文件管理优化
- 优先使用项目目录内的配置文件：`$SCRIPT_DIR/config/`
- 优化软链接创建逻辑，减少系统调用
- 使用批量配置更新减少 I/O 操作
- 实现配置文件的原子更新和回滚
- 示例优化模式：
  ```bash
  # 优化前：多次文件操作
  echo "config1" > /etc/zt-gateway/file1
  echo "config2" > /etc/zt-gateway/file2

  # 优化后：批量操作
  {
      echo "config1" > "$SCRIPT_DIR/config/file1"
      echo "config2" > "$SCRIPT_DIR/config/file2"
  } && sync_project_configs_to_system
  ```

### 依赖检查
- 检查必需命令的可用性
- 验证网络接口存在性
- 确认系统服务状态
- 检查配置文件完整性

### 原子操作
- 确保配置更新的原子性
- 使用临时文件和安全的移动操作
- 提供回滚机制

## 代码质量

### 遵循项目规范
- 统一的变量命名：全大写，下划线分隔
- 统一的函数命名：小写，下划线分隔
- 统一的日志格式：`log "级别" "消息"`
- 统一的错误处理：`handle_error "错误信息"`

### 代码结构
- 函数功能单一化
- 减少全局变量使用
- 增加必要的注释说明
- 提取公共逻辑到函数

### 安全考虑
- 避免代码注入风险
- 安全地处理用户输入
- 使用引号保护变量
- 避免使用危险的 `eval`

## 兼容性

### 系统兼容性
- 确保在不同 CentOS 版本上运行
- 处理不同网络配置环境
- 兼容不同版本的网络工具

### 向后兼容
- 保持现有配置文件格式
- 维持现有命令行接口
- 确保现有功能不受影响

请分析代码并提供优化建议和改进后的代码。
